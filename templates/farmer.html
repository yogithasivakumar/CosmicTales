<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Farmer Raviâ€™s Smart Farm ğŸŒ¾</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: radial-gradient(circle at top, #0a1f4f 0%, #1a2a6c 100%);
    color: #fff;
    display: flex;
    flex-direction: column;
    align-items: center;
    min-height: 100vh;
    overflow-x: hidden;
    margin: 0;
    padding: 0;
  }

  header {
    width: 100%;
    max-width: 900px;
    margin: 1rem auto;
    text-align: center;
    background: rgba(10,30,80,0.95);
    padding: 1rem 2rem;
    border-radius: 20px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    position: relative;
  }
  header h1 {
    font-size: 2rem;
    color: #ffd700;
    margin-bottom: 0.5rem;
  }
  #storyText {
    font-size: 1.2rem;
    color: #ffd700;
  }
  #closeBtn {
    position: absolute;
    top: 1rem;
    right: 2rem;
    padding: 0.6rem 1.4rem;
    font-size: 1rem;
    color: #fff;
    background: #ff4b4b;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
  }
  #closeBtn:hover { background: #e03f3f; }

  .flip-container {
    width: 100%;
    max-width: 900px;
    margin: 1rem auto;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  #storyContainer {
    width: 100%;
    background: rgba(10,30,80,0.95);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 8px 25px rgba(0,0,0,0.6);
    position: relative;
    text-align: center;
    min-height: 450px;
    overflow: hidden;
  }

  .storyPage {
    display: none;
    flex-direction: column;
    align-items: center;
    animation: fadeIn 0.5s ease;
    position: relative;
    min-height: 400px;
  }
  .storyPage.active { display: flex; }

  @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

  .characterName {
    font-size: 1.5rem;
    font-weight: bold;
    color: #ffd700;
    margin-bottom: 0.5rem;
  }
  .storyText {
    font-size: 1.2rem;
    margin-bottom: 1rem;
  }

  /* Farmer and Compass layout */
  .farmer-emoji {
    font-size: 12rem;
    position: absolute;
    bottom: 0;
    left: 10%;
    animation: bounce 2s ease-in-out infinite;
    z-index: 4;
  }

  .compass-emoji {
    font-size: 6rem;
    position: absolute;
    bottom: 40px;
    left: 35%;
    animation: rotateCompass 6s linear infinite, floatCompass 3s ease-in-out infinite;
    transform-style: preserve-3d;
    z-index: 3;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
  @keyframes rotateCompass {
    0% { transform: rotateY(0deg); }
    100% { transform: rotateY(360deg); }
  }
  @keyframes floatCompass {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }

  .signal-antenna {
    font-size: 5rem;
    position: absolute;
    bottom: 130px;
    left: 50%;
    transform: translateX(-50%);
    animation: wiggle 0.8s infinite;
    z-index: 3;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .low-text {
    font-size: 2rem;
    color: yellow;
    font-weight: bold;
    animation: pop 0.6s ease-in-out infinite alternate;
  }

  @keyframes wiggle {
    0%   { transform: translateX(0) translateY(0) rotate(0deg); }
    15%  { transform: translateX(-5px) translateY(-5px) rotate(-10deg); }
    30%  { transform: translateX(5px) translateY(3px) rotate(10deg); }
    45%  { transform: translateX(-3px) translateY(-2px) rotate(-5deg); }
    60%  { transform: translateX(3px) translateY(2px) rotate(5deg); }
    75%  { transform: translateX(-2px) translateY(1px) rotate(-2deg); }
    100% { transform: translateX(0) translateY(0) rotate(0deg); }
  }
  @keyframes pop {
    0% { transform: scale(1); opacity: 0.6; }
    50% { transform: scale(1.3); opacity: 1; }
    100% { transform: scale(1); opacity: 0.6; }
  }

  .satellite {
    position: absolute;
    top: 50%;
    left: 50%;
    transform-origin: -120px 0;
    animation: orbit 6s linear infinite;
  }
  @keyframes orbit {
    0% { transform: rotate(0deg) translateX(120px) rotate(0deg); }
    100% { transform: rotate(360deg) translateX(120px) rotate(-360deg); }
  }

  .signal-flare {
    position: absolute;
    animation: flicker 0.5s infinite alternate;
  }
  @keyframes flicker {
    0% { opacity: 1; transform: translateX(0) translateY(0); }
    50% { opacity: 0.5; transform: translateX(5px) translateY(-5px); }
    100% { opacity: 1; transform: translateX(0) translateY(0); }
  }

  .book-emoji {
    font-size: 5rem;
    cursor: pointer;
    animation: bookBounce 1.5s infinite;
  }
  @keyframes bookBounce {
    0%,100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }
  .fact-popup {
    position: absolute;
    top: 100px;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(255,255,0,0.9);
    color: #000;
    padding: 1rem 2rem;
    border-radius: 15px;
    font-weight: bold;
    display: none;
    z-index: 10;
  }

  .veggie {
    position: absolute;
    bottom: 0;
    font-size: 2.5rem;
    animation: floatVeggies 5s linear infinite;
    opacity: 0.9;
  }
  @keyframes floatVeggies {
    0% { transform: translateY(0) scale(1); opacity: 1; }
    100% { transform: translateY(-500px) scale(1.2); opacity: 0; }
  }
</style>
</head>
<body>
<header>
  <h1>Farmer Raviâ€™s Smart Farm ğŸŒ¾</h1>
  <div id="storyText">Click a page to interact!</div>
  <button id="closeBtn">Close</button>
</header>

<div class="flip-container">
  <div id="storyContainer">
    <!-- Page 1 -->
    <div class="storyPage active" data-page="1">
      <div class="characterName">Meet Farmer Ravi ğŸ‘¨â€ğŸŒ¾</div>
      <div class="storyText">â€œHi, Iâ€™m Farmer Ravi. My GPS tractor helps me water crops and plant seeds on time!â€</div>
      <div class="farmer-emoji">ğŸ§‘â€ğŸŒ¾</div>
      <div class="compass-emoji">ğŸ§­</div>
    </div>

    <!-- Page 2 -->
    <div class="storyPage" data-page="2">
      <div class="characterName">Solar Flare Alert âš¡</div>
      <div class="storyText">â€œOh no! My radio crackles. Communication with the tower is weak!â€</div>
      <div class="signal-antenna">ğŸ“¡ <span class="low-text">LOW</span></div>
      <div class="farmer-emoji">ğŸ§‘â€ğŸŒ¾</div>
    </div>

    <!-- Page 3 -->
    <div class="storyPage" data-page="3">
      <div class="characterName">Understanding Satellites</div>
      <div class="storyText">â€œMy tools rely on satellites. Solar flares can mess with their signals.â€</div>
      <div class="satellite" style="font-size:5rem;">ğŸ›°ï¸</div>
      <div class="satellite" style="font-size:5rem; animation-delay: 2s;">ğŸ›°ï¸</div>
      <div class="satellite" style="font-size:5rem; animation-delay: 4s;">ğŸ›°ï¸</div>
      <div class="signal-flare" style="font-size:3rem; top: 30%; left: 60%;">âš¡</div>
      <div class="signal-flare" style="font-size:3rem; top: 70%; left: 40%; animation-delay:0.3s;">âš¡</div>
      <div class="farmer-emoji">ğŸ§‘â€ğŸŒ¾</div>
    </div>

    <!-- Page 4 -->
    <div class="storyPage" data-page="4">
      <div class="characterName">Problem Solving</div>
      <div class="storyText">â€œLetâ€™s fix it! Iâ€™ll try recalibrating the GPS and wait for the flare to pass.â€</div>
      <div id="gpsGame" style="position:relative; width:100%; height:250px; margin-top:20px; border:2px dashed #ffd700; border-radius:15px;">
        <div id="target" style="position:absolute; top:50px; left:0; font-size:4rem;">ğŸ¯</div>
        <div id="satelliteClick" style="position:absolute; top:150px; left:0; font-size:5rem; cursor:pointer;">ğŸ›°ï¸</div>
        <div id="recalibrated" style="position:absolute; top:100px; left:50%; transform:translateX(-50%); font-size:2rem; color:#ffd700; display:none;">GPS Recalibrated âœ…</div>
      </div>
    </div>

    <!-- Page 5 -->
    <div class="storyPage" data-page="5">
      <div class="characterName">Learning Moment</div>
      <div class="storyText">â€œSolar storms can affect farmers like me. Thatâ€™s why scientists track the Sun.â€</div>
      <div class="farmer-emoji">ğŸ§‘â€ğŸŒ¾</div>
      <div id="book" class="book-emoji">ğŸ“š</div>
      <div id="fact" class="fact-popup">ğŸŒ Solar flares can disturb GPS satellites!</div>
    </div>

    <!-- Page 6 -->
    <div class="storyPage" data-page="6">
      <div class="characterName">Happy Farm</div>
      <div class="storyText">â€œYay! The signals are back. Now I can water my crops and make my vegetables grow!â€</div>
      <div class="farmer-emoji">ğŸ§‘â€ğŸŒ¾</div>
      <div class="veggie" style="left:20%;">ğŸ¥•</div>
      <div class="veggie" style="left:40%; animation-delay:1s;">ğŸŒ½</div>
      <div class="veggie" style="left:60%; animation-delay:2s;">ğŸ…</div>
      <div class="veggie" style="left:80%; animation-delay:3s;">ğŸ†</div>
    </div>
  </div>
</div>

<audio id="gpsSound" src="{{ url_for('static', filename='audio/gps_success.mp3') }}"></audio>

<script>
const pages = document.querySelectorAll('.storyPage');
let currentPage = 0;
let synth = window.speechSynthesis;
let utter = null;
let maleVoice = null;

function loadVoices() {
  const voices = synth.getVoices();
  maleVoice = voices.find(v => /male/i.test(v.name)) || voices[0];
}
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = loadVoices;
}
loadVoices();

function showPage(index) {
  if(index < 0 || index >= pages.length) return;
  pages.forEach(p => p.classList.remove('active'));
  pages[index].classList.add('active');
  currentPage = index;
  speak(pages[index].querySelector('.storyText').innerText);
}

function speak(text){
  if('speechSynthesis' in window){
    if(utter) synth.cancel();
    utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'en-US';
    utter.rate = 0.9;
    utter.pitch = 1.1;
    if(maleVoice) utter.voice = maleVoice;
    synth.speak(utter);
  }
}

document.addEventListener('keydown', (e)=>{
  if(e.key==='ArrowRight') showPage(currentPage+1);
  if(e.key==='ArrowLeft') showPage(currentPage-1);
});

document.getElementById('closeBtn').addEventListener('click', ()=>{
  if(utter) synth.cancel();
  window.location.href='/dashboard';
});

window.addEventListener('load', ()=> showPage(0));

/* Page 4 GPS game */
function initGPSGame() {
  const page4 = document.querySelector('.storyPage[data-page="4"]');
  if (!page4) return;

  const target = page4.querySelector('#target');
  const satelliteClick = page4.querySelector('#satelliteClick');
  const recalibrated = page4.querySelector('#recalibrated');
  const gpsSound = document.getElementById('gpsSound');
  let direction = 1;
  let wigglePhase = 0;

  function moveTarget() {
    const containerWidth = target.parentElement.offsetWidth;
    let left = parseInt(target.style.left) || 0;
    left += 3 * direction;
    if(left <= 0 || left >= containerWidth - 50) direction *= -1;

    wigglePhase += 0.1;
    const top = 50 + Math.sin(wigglePhase) * 20;
    target.style.left = left + 'px';
    target.style.top = top + 'px';

    requestAnimationFrame(moveTarget);
  }
  moveTarget();

  satelliteClick.addEventListener('click', ()=>{
    const targetRect = target.getBoundingClientRect();
    const satelliteRect = satelliteClick.getBoundingClientRect();
    const distance = Math.abs((targetRect.left + targetRect.width/2) - (satelliteRect.left + satelliteRect.width/2));
    if(distance < 50){
      recalibrated.textContent = 'GPS Recalibrated âœ…';
      recalibrated.style.display = 'block';
      gpsSound.currentTime = 0;
      gpsSound.play();
      setTimeout(()=> recalibrated.style.display='none', 2000);
    } else {
      recalibrated.textContent = 'Try Again âŒ';
      recalibrated.style.display = 'block';
      setTimeout(()=> recalibrated.style.display='none', 1500);
    }
  });
}
window.addEventListener('load', initGPSGame);

/* Page 5 book interaction */
const book = document.getElementById('book');
const fact = document.getElementById('fact');
if(book){
  book.addEventListener('click', ()=>{
    fact.style.display = 'block';
    setTimeout(()=> fact.style.display = 'none', 2500);
  });
}
</script>
</body>
</html>
